_configure() {
	make mrproper

	case ${ARCH} in
		x86_64)
			KARCH=x86
			DEFCONFIG=x86_64_defconfig
		;;
		i?86)
			KARCH=x86
			DEFCONFIG=i386_defconfig
		;;
		powerpc)
			KARCH=powerpc
			DEFCONFIG=pmac32_defconfig
		;;
		powerpc64)
			KARCH=powerpc
			DEFCONFIG=ppc64_defconfig
		;;
		aarch64)
			KARCH=arm64
			DEFCONFIG=defconfig
		;;
		arm)
			KARCH=arm
			DEFCONFIG=bcm2835_defconfig
		;;
		*)
			KARCH=${ARCH}
			DEFCONFIG=defconfig
		;;
	esac

	# FIXME - use a proper config!
	make ARCH=${KARCH} ${DEFCONFIG}
}

_build() {
	make -j${THREADS} ARCH=${KARCH}
}

_install() {
	make modules_install

	cp -iv arch/x86/boot/bzImage /boot/vmlinuz-$version
	cp -iv System.map /boot/System.map-$version
	cp -iv .config /boot/config-$version

	install -d /usr/share/doc/linux-$version
	cp -r Documentation/* /usr/share/doc/linux-$version

	install -v -m755 -d /etc/modprobe.d
	cp -v ${COMPDIR}/linux/files/usb.conf /etc/modprobe.d/usb.conf
}
